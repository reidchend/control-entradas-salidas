name: Build Android APK (Final Strategy)
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Build Tools
        run: |
          python -m pip install --upgrade pip
          # Instalamos flet y herramientas de empaquetado
          pip install flet cookiecutter

      - name: Prepare Minimal Requirements
        run: |
          # El error "Packaging Python app" suele ser por librerías incompatibles.
          # Vamos a dejar solo lo vital. 
          # NOTA: No incluyas 'flet' aquí, flet ya está en el core del build.
          echo "pg8000" > requirements.txt
          echo "python-dotenv" >> requirements.txt
          echo "pydantic-settings" >> requirements.txt
          # Si usas alguna otra librería, asegúrate de que sea puro Python (no C++)

      - name: Build APK
        run: |
          export FLUTTER_ROOT=$FLUTTER_HOME
          export PATH=$PATH:$FLUTTER_HOME/bin:$ANDROID_HOME/cmdline-tools/latest/bin
          
          # Aceptamos licencias
          yes | sdkmanager --licenses > /dev/null || true
          
          # Forzamos la limpieza del build anterior si existiera
          rm -rf build
          
          # Usamos el comando build indicando explícitamente que no sea interactivo
          # Agregamos --no-android-archive para acelerar y evitar errores de empaquetado extra
          flet build apk \
            --project "LycorisControl" \
            --include-all-extras \
            --verbose
        env:
          CI: true
          # Aumentamos agresivamente la memoria de Gradle
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.parallel=false"

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Lycoris-Control-App
          path: build/apk/*.apk
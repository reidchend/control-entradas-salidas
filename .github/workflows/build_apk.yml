name: Build Android APK (The Final Stand)
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          # Bajamos un escalón a una versión de Flutter ultra-compatible
          flutter-version: '3.24.5' 

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Flet (Stable Version)
        run: |
          pip install flet==0.24.1 cookiecutter 
          # Instalamos la 0.24.1 que corresponde a un CLI más estable

      - name: Build APK
        run: |
          # 1. Aceptar licencias MODO FLUTTER
          # El "yes" alimentando al comando de flutter es infalible
          mkdir -p $HOME/.android
          touch $HOME/.android/repositories.cfg
          yes | flutter doctor --android-licenses

          # 2. Variables de entorno sólidas
          export FLUTTER_ROOT=$FLUTTER_HOME
          export PATH=$PATH:$FLUTTER_HOME/bin
          
          # 3. Limpieza de cualquier basura previa
          rm -rf build android build_app pure_app
          
          # 4. Crear carpeta de app limpia
          mkdir build_app
          cp *.py build_app/ || true
          cp -r assets build_app/ || true
          echo "pg8000" > build_app/requirements.txt
          echo "python-dotenv" >> build_app/requirements.txt
          
          # 5. EL COMANDO
          # Usamos la bandera --no-gradle-daemon para evitar cuelgues de memoria
          cd build_app
          flet build apk --verbose
          
          # 6. Mover el botín
          mkdir -p $GITHUB_WORKSPACE/output
          cp build/apk/*.apk $GITHUB_WORKSPACE/output/ || true
        env:
          CI: true
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx3g"

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Lycoris-Control-Stable
          path: output/*.apk